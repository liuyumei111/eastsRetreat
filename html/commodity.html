<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>商品中心</title>
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="../css/aui.2.0.css">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/alert.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/common1.css">
    <link rel="stylesheet" href="../css/commodity.css">
</head>
<body>
<!--搜索框-->
<header>
    <div class="aui-searchbar" id="search">
        <div class="aui-searchbar-input aui-border-radius">
            <form class="search-form">
                <i class="aui-iconfont aui-icon-search"></i>
                <input type="search" placeholder="请输入搜索内容" id="search-input" autocomplete="off">
                <div class="aui-searchbar-clear-btn" id="clean-search">
                    <i class="aui-iconfont aui-icon-close"></i>
                </div>
            </form>
        </div>
        <div class="aui-searchbar-btn aui-text-info" tapmode style="cursor:pointer">搜索</div>
    </div>
</header>

<!--中间部分-->
<section class="comm-box">
    <!--筛选部分-->
    <div class="dis-select-box" id="dis-select-box">
        <script type="text/x-handlebars-template" id="select-template">
            <select class="dis-shop-type" id="shop-type-box">
                {{#each this}}
                <option value="{{id}}">{{name}}({{count}})</option>
                {{/each}}
            </select>
            <select class="dis-shop-sort">
                <option value="">默认排序</option>
                <option value="priceAsc">价格由低到高</option>
                <option value="priceDesc">价格由高到低</option>
                <option value="salesDesc">销量由高到低</option>
            </select>
            <div class="dis-screen-btn">筛选</div>
            <div class="dis-screen">
                <div class="dis-screen-price">
                    <div class="dis-price-section">价格区间</div>
                    <div class="dis-screen-select">
                        <input type="number" class="dis-low-price" placeholder="最低价">
                        <div class="dis-price-line"></div>
                        <input type="number" class="dis-high-price" placeholder="最高价">
                    </div>
                    <div class="dis-price-section">商品销量</div>
                    <div class="dis-screen-select">
                        <input type="number" class="dis-low-sales" placeholder="最低销量">
                        <div class="dis-price-line"></div>
                        <input type="number" class="dis-high-sales" placeholder="最高销量">
                    </div>
                    <div class="aui-list-item-inner">
                        <label><input class="aui-radio servenBack" type="checkbox" name="radio2"> 退货免运费</label>
                    </div>
                    <div id="nmbConfirm">确定</div>
                </div>
            </div>
        </script>
    </div>
    <!--列表渲染-->
    <div id="dis-list-vessel" class="mar-bottom">
        <script type="text/x-handlebars-template" id="discount-list-template">
            {{#each products}}
            <a href="goodsdetail.html?productId={{id}}" class="display-box">
                <div class="dis-list-box" data-shopid="{{id}}" data-productid="{{productId}}">
                    <div class="dis-shop-img">
                        <img src="../images/lazy.gif" data-src="{{mainImageUrl}}" alt="">
                    </div>
                    <div class="dis-list-content">
                        <div class="dis-shop-detail">
                            <span class="hongbao">红包{{productHongbao}}元</span>
                            <span class="shop-list-name">{{name}}</span>
                        </div>
                        <div class="dis-price">
                            <span>优惠价:{{productPrice}}元</span>
                            <span>原价:{{productOrginPrice}}元</span>
                        </div>
                        <div class="dis-evaluate">
                            <span>赚:{{marketProfit}}元</span>
                            <span>佣金率 <span>{{marketProfitPercent}}</span></span>
                        </div>
                        <div class="dis-del-sale">
                            <div class="dis-del"></div>
                            <div class="dis-sale ">
                                <span class="now-tuiguang">立即推广</span>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
            {{/each}}
        </script>
    </div>
    <div class="loading">加载更多...</div>
    <div class="no-info">没有更多信息了...</div>
    <div class="default-height"></div>

    <!--立即推广-->
    <section class="wxmass-sends">
        <section class="wxmass-sends-item">
            <div class="wxmass-item-title">
                <span class="cancel">取消</span>
                <span>分享</span>

            </div>
            <!--<div class="wxmass-item-img">
                <img src="../images/banner1.png" alt="">
            </div>-->
            <ul class="wxmass-item-list">
                <li class="share-firends">
                    <div class="wxmass-item-list-img">
                        <img src="../images/sends1.png" alt="">
                    </div>
                    <span>发送给朋友</span>
                    <div class="aui-col-xs-3 wxmass-col-xs-3">
                        <i class="aui-iconfont aui-icon-right"></i>
                    </div>
                </li>
                <li class="share-firends-quan">
                    <div class="wxmass-item-list-img">
                        <img src="../images/sends2.png" alt="">
                    </div>
                    <span>分享到朋友圈</span>
                    <div class="aui-col-xs-3 wxmass-col-xs-3">
                        <i class="aui-iconfont aui-icon-right"></i>
                    </div>
                </li>
                <li class="share-QQ">
                    <div class="wxmass-item-list-img">
                        <img src="../images/sends2.png" alt="">
                    </div>
                    <span>分享到QQ</span>
                    <div class="aui-col-xs-3 wxmass-col-xs-3">
                        <i class="aui-iconfont aui-icon-right"></i>
                    </div>
                </li>
                <li class="share-weibo">
                    <div class="wxmass-item-list-img">
                        <img src="../images/sends2.png" alt="">
                    </div>
                    <span>分享到微博</span>
                    <div class="aui-col-xs-3 wxmass-col-xs-3">
                        <i class="aui-iconfont aui-icon-right"></i>
                    </div>
                </li>
            </ul>
        </section>
    </section>
</section>

<section class="share-loading">
    <img src="../images/loading.gif" alt="">
</section>
<!--底部栏-->
<footer class="aui-bar aui-bar-tab" id="footer">
    <a href="index.html">
        <div class="aui-bar-tab-item" tapmode>
            <i class="aui-iconfont aui-icon-home"></i>
            <div class="aui-bar-tab-label">首页</div>
        </div>
    </a>
    <a href="extension.html">
        <div class="aui-bar-tab-item" tapmode>
            <i class="aui-iconfont aui-icon-calendar"></i>
            <div class="aui-bar-tab-label">推广中心</div>
        </div>
    </a>
    <a href="javascript:;">
        <div class="aui-bar-tab-item my-aui-active" tapmode>
            <i class="aui-iconfont aui-icon-cert"></i>
            <div class="aui-bar-tab-label">商品中心</div>
        </div>
    </a>
    <a href="my.html">
        <div class="aui-bar-tab-item" tapmode>
            <i class="aui-iconfont aui-icon-my"></i>
            <div class="aui-bar-tab-label">我</div>
        </div>
    </a>
</footer>

<script src="../js/jquery-3.0.0.min.js"></script>
<script src="../js/handlebars-v4.0.10.js"></script>
<script src="../js/config.js"></script>
<script src="../js/function.js"></script>
<script src="../js/alert.js"></script>
<script src="../js/aui-lazyload.js"></script>
<script src="../js/api.2.0.js"></script>
<script src="../js/api.js"></script>
<script src="../js/search.js"></script>
<script>

    //商品信息
    var shoptpl = $('#discount-list-template').html();
    var shopTemplate = Handlebars.compile(shoptpl);
    //筛选(全部)
    var selectTpl = $('#select-template').html();
    var selectCmp = Handlebars.compile(selectTpl);

    //后台获取的首页数据(ajax请求地址)
    var uri = C.interface.discount;
    //后台获取的首页数据(获取商品分类)
    var selectUri = C.interface.selectType;

    //ajax加载商品列表(分页)
    var categoryId = '', orderType = '', pageLength = 5, minMaxPrice = '', minMaxSales = '';

    var range = 200, //距下边界长度/单位px
        maxnum = 0, //设置总数
        num = 0, //当前数量
        totalheight = 0,
        flag = 0,
        start = '0',
        searchName = '';

    //获取商品类别(全部，男装，女装,饮料，家电)
    $.ajax({
        url: selectUri,
        type: 'get',
        dataType: 'json',
        data: {},
        success: function (response) {
            if (response.result == 'success') {
                //商品类别(全部，男装，女装,饮料，家电)
                var selectData = response.data;
                //console.log(selectData);
                //handlebars渲染数据
                $('#dis-select-box').html(selectCmp(selectData));
                //加载商品数据
                ajaxGetShopData();


                //点击全部，可以选择商品类别
                $(document).on('change', '.dis-shop-type', function () {
                    //清空整个列表的数据
                    $('#dis-list-vessel').empty();
                    //
                    categoryId = $(this).val();
//                    console.log(categoryId);
                    num = 0;
                    start = num;
                    //加载商品数据
                    ajaxGetShopData();
                });


//                点击排序
                $(document).on('change', '.dis-shop-sort', function () {
                    $('#dis-list-vessel').empty();
                    orderType = $(this).val();
//                    console.log(orderType);
                    num = 0;
                    start = num;
                    ajaxGetShopData();
                });

                /*筛选按钮的切换*/
                $('.dis-screen-btn').click(function () {
                    $(this).toggleClass('dis-screen-active');
                    $('.dis-screen').toggle();
                });

            } else if (response.result == 'login') {
                alert('登入过期，请重新登入！');
                againLogin();
            } else {
                alert(response.errorMsg);
            }
        }

    });


    //搜索功能
            //手机端软键盘搜索
    $('.search-form').submit(function (e) {
        e.preventDefault();
        searchName = $('#search-input').val();
        console.log(searchName);
        if (searchName == '') {
            return false;
        }
        $('#dis-select-box').hide();
//        清空
        $('#dis-list-vessel').empty();
        num = 0;
        start = num;
        ajaxGetShopData();
    });

    //点击搜索按钮搜索
    $(document).on('click', '.aui-text-info', function (e) {
        $('.search-from').trigger('submit');
        searchName = $('#search-input').val();
        console.log(searchName);
        if (searchName == '') {
            return false;
        }
        $('#dis-select-box').hide();
//        清空
        $('#dis-list-vessel').empty();
        num = 0;
        start = num;
        ajaxGetShopData();
    });

    //删除文本之后请求数据。
    $(document).on('click', '#clean-search', function () {
        $('#dis-select-box').show();
        $('#dis-list-vessel').empty();
        searchName = '';
        num = 0;
        start = num;
        ajaxGetShopData();
    });

    //监听滚动高度，加载数据
    $(window).on('scroll', function () {
        var srollPos = $(window).scrollTop(); //滚动条距顶部距离(页面超出窗口的高度)
        //console.log("滚动条到顶部的垂直高度: " + $(document).scrollTop());
        //console.log("页面的文档高度 ："+$(document).height());
        //console.log('浏览器的高度：'+$(window).height());
        totalheight = parseFloat($(window).height()) + parseFloat(srollPos);

        if (num >= maxnum) {
            return;
        }
        if (($(document).height() - range) <= totalheight && num < maxnum) {
            //这里不能使用模板填充，应该是append()....
            ajaxGetShopData();
        }
    });

    //加载商品数据
    function ajaxGetShopData() {
        //如果条件不成立直接不执行
        if (flag) {
            return;
        }
        //条件成立
        //显示加载更多
        $(".no-info").hide();
        $('.loading').show();
        flag = 1;
        $.ajax({
            url: uri,
            type: 'POST',
            dataType: 'json',
            data: {
                categoryId: categoryId,
                orderType: orderType,
                start: start,
                length: pageLength,
                minMaxPrice: minMaxPrice,
                minMaxSales: minMaxSales,
                name: searchName
            },
            success: function (response) {
                if (response.result == 'success') {

                    minMaxPrice='';
                    minMaxSales='';

                    //显示加载隐藏
                    $('.loading').hide();
                    //每次都加1
                    num++;
                    //请求回来的数据
                    var data = response.data;
                    //console.log(data);
                    //商品的总数
                    maxnum = data['productCount'];
                    //因为数据库采用的是行偏移量，所以这里需要num*pageLength
                    start = num * pageLength;
                    //当上平的总数等于0的时候显示没有更多信息了...
                    if (maxnum == 0) {
                        $(".no-info").show();
                    }
                    //如果请求回来的数据条数大于0，在数据后插入新新数据，不覆盖旧数据;否则就显示没有更多信息了
                    if (data.products.length > 0) {
                        $('#dis-list-vessel').append(shopTemplate(data));
                        new auiLazyload({
                            errorImage: '../images/error-img.png'
                        });
                    } else {
                        $(".no-info").show();
                        num = maxnum + 1;
                    }
                    flag = 0;

                    //这里添加立即推广事件
                    $('.now-tuiguang').unbind().bind('click', nowTuiGuang);
                    //取消分享弹框
                    $('.cancel').click(function () {
                        $('.wxmass-sends').hide();
                    });
                } else {
                    alert(response.errorMsg);
                }
            },
            error: function () {
                alert('服务器异常');
            }
        })
    }

    //立即推广
    function nowTuiGuang(event) {
        event.preventDefault();
        event.stopPropagation();
        var loading=dialog.loading();

        var that = $(this);
        var thisPapa = that.parents('.dis-list-box');
        var thisImg = thisPapa.find('.dis-shop-img').find('img').attr('src');
        var shareProductId = thisPapa.data('shopid');
        console.log(shareProductId);

        //localStorage.setItem('shareId', shareProductId);

        $('.wxmass-item-img').find('img').attr('src', thisImg);


        $.ajax({
            url: C.marketInterface.shareFriend,
            type: 'get',
            dataType: 'json',
            data: {
                token: C.marketToken,
                productId: shareProductId
            },
            complete:function () {
                loading.close();
            },
            success: function (response) {
                if (response.result == 'success') {
                    //console.log(response.data);
                    var imgUrl = response.data.imgUrl;
                    var url = response.data.url;
                    var title = response.data.title;
                    var content = response.data.content;

                    $('.share-loading').hide();
                    $('.wxmass-sends').show();


                    $('.share-firends').bind('click', function (event) {
                        getShareType(event, '1');

                    });

                    $('.share-firends-quan').bind('click', function (event) {
                        getShareType(event, '2');
                    });
                    $('.share-QQ').bind('click',function (event) {
                        getShareType(event, '3');
                    });
                    $('.share-weibo').bind('click',function (event) {
                        getShareType('event','4');
                    });

                    function getShareType(event, type) {
                        event.preventDefault();
                        var shareData = {
                            postType: 'shareProducts',
                            productId: shareProductId,
                            type: type,
                            url: url,
                            imgUrl: String(imgUrl),
                            title: title,
                            content: content
                        };
                        //console.log(shareData);

                        var ua = navigator.userAgent.toLowerCase();
                        if (/iphone|ipad|ipod/.test(ua)) {

                            console.log(shareData);
                            iosShare(shareData);
                            event.stopPropagation();
                        } else {
                            //console.log(JSON.stringify(data));
                            androidShare(JSON.stringify(shareData));
                            event.stopPropagation();
                        }
                    }

                }else if (response.result === 'login'){
                    alert('登入过期，请重新登入！');
                    againLogin();
                }
            },
            error: function () {
                alert('服务器异常');
            }
        });
    }

    //拉取安卓分享
    function androidShare(param) {
        window.huifa.shareProducts(param);
    }

    //拉取iOS分享

    function iosShare(param) {
        window.webkit.messageHandlers.shareProducts.postMessage(param);
    }


    //点击确定筛选
    $(document).on('click', '#nmbConfirm', function () {
        getScreen()
    });

    //关闭当前筛选菜单栏
    $('.all-mask').bind('click', function () {
        $('.dis-screen-price').hide();
    });


    //商品筛选
    function getScreen() {
        //当前筛选菜单栏
//        $('.all-mask').show();
//        全部
        var shopType = $('.dis-shop-type').val();
//        默认排序
        var shopSales = $('.dis-shop-sort').val();
//          最低价
        var lowPrice = $('.dis-low-price').val();
//          最高价
        var highPrice = $('.dis-high-price').val();
//         最低销量
        var lowSales = $('.dis-low-sales').val();
//        最高销量
        var highSales = $('.dis-high-sales').val();

//        最低价-最高价
        minMaxPrice = lowPrice + '-' + highPrice;
//        最低销量-最高销量
        minMaxSales = lowSales + '-' + highSales;
//        定义一个变量
        var servenBack = null;
//        console.log(minMaxPrice);
//        console.log(minMaxSales);
//      退货免运费选项是否选中
        if ($('.servenBack').is(':checked')) {
            servenBack = 1;
        } else {
            servenBack = 0;
        }
//        如果 最低价-最高价  最低销量-最高销量  =空
        if (lowPrice == '' && highPrice == '' && lowSales == '' && highSales == ''&&servenBack==null) {
            alert('没有填写筛选数据');
            return false;
        }
//最低价不能大于最高价
        if (parseInt(lowPrice) > parseInt(highPrice)) {
            alert('最低价不能大于最高价');
            return false;
        }
        //最低销量不能大于最高销量
        if (parseInt(lowSales) > parseInt(highSales)) {
            alert('最低销量不能大于最高销量');
            return false;
        }

        $('.dis-screen').toggle();
        $('#dis-list-vessel').empty();

        //清空搜索数据
        $('.dis-low-price').val('');
        $('.dis-high-price').val('');
        $('.dis-low-sales').val('');
        $('.dis-high-sales').val('');

       ajaxGetShopData();
    }


    //红包
    Handlebars.registerHelper('hongbao', function (sales) {
        if (sales == null) {
            return null;
        } else {
            return sales;
        }
    });
    //包邮不包邮
    Handlebars.registerHelper('exemption', function (value) {
        if (value == '001') {
            return '退货免邮费';
        } else if (value == '002') {
            return '退货不包邮';
        }
    });

    $(document).ready(function () {
        new auiLazyload({
            errorImage: '../images/error-img.png'
        });
    });
</script>
<!--<script src="../js/commodity.js"></script>-->
</body>
</html>